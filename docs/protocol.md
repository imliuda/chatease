# 消息格式与通信协议
消息协议类似于http协议，由命令行、参数行和消息体构成。此协议的设计原则是能够在分布式系统中实现消息的快速响应，在同一个连接中，可对多个
较大的消息进行交叉发送，并保证长度较小的消息进行优先发送。对于包含文字、图片、音频等多个元素的信息，可先将文字、图片和语音等元信息首先
通过一个消息发送，然传再输消息的剩余部分，这样消息在用户端能够实现快速显示和预览，对于语音等，收听和传输可同时进行，实现消息的快速传递
和响应。
## 术语
**信息：**用户发送的一条消息，该条消息可包含多个子元素，是逻辑实体，信息通过多个“消息”进行传输  
**消息：**网络传输中的一个包或者帧，是传输的实体，意义是将“信息”分割成多个包进行传输
## 请求行
请求行由关键字“CMD”开始，用于表明一条消息的开始，后面跟随“命令”，或者称“消息类型”，然后是信息id，信息id为uuid类型，最后是消息的序列，
序列格式为“m/n”，代表“客户端发送的信息”一共需要n个消息传输完成，当前的消息为其中第m个消息，对于属于同一个信息的多个消息，其id必须相
同，来保证将多个消息单元最后组合称一个完成的信息。客户端发送的一条消息中可能同时包含文字、图
片、语音等，但他们是用户点击“发送”时发送的，对于用户这些元素构成一条信息，对于信息的传输，是通过多个消息来完成的。最后，请求行以“\r\n”
结束。请求行中的所有字符必须为ascii码字符。
## 参数行
参数行的格式同http头字段格式。参数行以\r\n结束，最后一个参数行以“\r\n\r\n”结束，表明所有参数都结束。接下来就是消息的主体信息。参数行
中的预定义标准字段有“size”，“type”、“checksum”，“from”和“to”，其中“size”，“from”和“to”字段是每条消息中必须包含的，“size”
表示消息体的长度，值用10进制整数进行表示。“from”和“to”是消息的发送者和接收者，用来唯一标识一个用户，这两个字段值的类型没有特殊要求，
可以为整数id和字符串，也可用电子邮件地址的形式实现目的地的快速查找。“type”表示消息体
数据的类型，该字段的值参考http的“Content-Type”字段，若消息未指定“type”，则认为消息体是utf-8编码的字符串。“checksum”表示消息体的
crc32校验和，以10进制整数来表示。若收到的消息中包含该字段，则应该对消息体进行校验并与该字段的值进行对比，若不相等，则应该丢弃此条消息。
## 消息体
消息体为消息的主体，其格式可为字符串类型，也可为二进制类型。消息体的处理需要根据参数行中的“type”来决定。
## 消息示例
CMD login bf997e18-8f07-11e6-b1b1-b46d8361714b 1/5\r\n  
size: 20\r\n  
from: obama\r\n  
to: xidada\r\n  
type: text/plain\r\n\r\n  

I AM THE MSG BODY...
## 核心消息类型（CMD Type）
用户的发送的信息由message和element两种类型组成，实现用户之间以多种信息形式进行聊天。本协议只规定这两个核心的消息类型。其他消息类型和
响应的参数由具体应用程序决定。
### message
message是一个json字符串，message中可包含多个element,每个element用json对象表示，每个element必须有type和id属性，用来表明此元素的
类型，type的取值参考HTTP的Content-Type。  
`["你好，这是我的第一条信息"]`  

`["请看这张图", {"id": 12133, type": "image/jpeg", "size": 2200}, "再看下
这个视频", {"id": 123, type": "video/avi" "size": 1616515156}]`
### element
element是message中element所对应的实体，element可为图片，照片，文件等。在用户信息的发送过程中，先发送message，如果用户信息中包含除
文本外的其他信息，则后续依次发送这些信息。element往往是比较大的文件，所以在发送这些信息时，应该在参数行中加入”offset“参数，服务器或
客户端在处理消息时可直接将消息写入文件的指定位置。